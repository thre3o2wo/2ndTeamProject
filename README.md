┌─────────────────────────────────────────────────────────────────────────────────┐
│                              사용자 인터페이스 (Django)                           │
│  ┌─────────────────────┐    ┌─────────────────────┐    ┌────────────────────┐   │
│  │   질문 입력 (Text)   │    │   파일 업로드 (PDF)  │    │   파일 업로드 (IMG) │   │
│  └──────────┬──────────┘    └──────────┬──────────┘    └──────────┬─────────┘   │
└─────────────┼──────────────────────────┼──────────────────────────┼─────────────┘
              │                          │                          │
              │                          ▼                          ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              OCR 모듈 (ocr_module.py)                           │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │  PDF: pdfplumber(텍스트) → PyMuPDF(렌더) → EasyOCR/Tesseract(이미지OCR)   │    │
│  │  이미지: EasyOCR(우선) → Tesseract(폴백)                                  │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
└───────────────────────────────────────┬─────────────────────────────────────────┘
              │                         │ extra_context (계약서 텍스트)
              ▼                         ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            RAG 파이프라인 (rag_module.py)                        │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │ STEP 1: 질문 표준화 (Query Normalization)                                │    │
│  │         • Upstage SOLAR Pro2 Chat 모델 사용                              │    │
│  │         • 일상어 → 법률 용어 변환 (예: "집주인" → "임대인")                 │   │
│  │         • 키워드 사전(KEYWORD_DICT) 참조                                  │   │
│  └───────────────────────────────────────┬─────────────────────────────────┘   │
│                                          │ normalized_query                     │
│                                          ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ STEP 2: 하이브리드 검색 (Triple Hybrid Retrieval)                         │   │
│  │                                                                          │   │
│  │  ┌──────────────┐   ┌──────────────┐   ┌──────────────┐                 │   │
│  │  │ 법령 (law)   │   │ 규정 (rule)   │   │ 판례 (case)  │                 │   │
│  │  │  law-index   │   │  rule-index  │   │  case-index  │                 │   │
│  │  └──────┬───────┘   └──────┬───────┘   └──────┬───────┘                 │   │
│  │         │                  │                  │                          │   │
│  │         ▼                  ▼                  ▼                          │   │
│  │    ┌─────────────────────────────────────────────────┐                  │   │
│  │    │          Dense 검색 (Pinecone Vector Store)      │                  │   │
│  │    │          Upstage Embeddings (passage-query)     │                  │   │
│  │    └──────────────────────┬──────────────────────────┘                  │   │
│  │                           │                                              │   │
│  │                           ▼                                              │   │
│  │    ┌─────────────────────────────────────────────────┐                  │   │
│  │    │          Sparse 검색 (BM25)                     │                  │   │
│  │    │          • BM25-Text (본문 내용)                 │                  │   │
│  │    │          • BM25-Title (제목/출처)                │                  │   │
│  │    │          Kiwi 형태소 분석기 사용                  │                  │   │
│  │    └──────────────────────┬──────────────────────────┘                  │   │
│  │                           │                                              │   │
│  │                           ▼                                              │   │
│  │    ┌─────────────────────────────────────────────────┐                  │   │
│  │    │      RRF (Reciprocal Rank Fusion)               │                  │   │
│  │    │      3채널 결합: Dense + BM25-Text + BM25-Title  │                  │   │
│  │    └──────────────────────┬──────────────────────────┘                  │   │
│  │                           │                                              │   │
│  └───────────────────────────┼──────────────────────────────────────────────┘  │
│                              │ 후보 문서들 (law + rule + case)                   │
│                              ▼                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ STEP 3: 리랭킹 (Reranking)                                               │   │
│  │         • Cohere Reranker (rerank-multilingual-v3.0)                    │   │
│  │         • 최대 입력 문서 수 제한 (기본 80개)                               │   │
│  │         • 법령/규정 우선 → 판례는 남는 슬롯만                              │   │
│  └───────────────────────────────┬─────────────────────────────────────────┘   │
│                                  │ reranked_docs                                │
│                                  ▼                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ STEP 4: 컨텍스트 포맷팅                                                   │   │
│  │         • 법적 위계 구분 (SECTION 0/1/2/3)                                │   │
│  │           - SECTION 0: 사용자 계약서 OCR (있을 경우)                      │    │
│  │           - SECTION 1: 핵심 법령 (priority 1, 2, 4, 5)                   │    │
│  │           - SECTION 2: 관련 규정 (priority 3, 6, 7, 8, 11)               │    │
│  │           - SECTION 3: 판례/사례                                         │    │
│  │         • 각 문서: '{src_title} {article} - {text}' 형식                 │    │
│  └───────────────────────────────┬─────────────────────────────────────────┘    │
│                                  │ formatted_context                            │
│                                  ▼                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ STEP 5: 답변 생성 (Answer Generation)                                    │   │
│  │         • OpenAI GPT-4o-mini 모델                                        │   │
│  │         • SYSTEM_PROMPT: 법률 상담 지침 포함                             │    │
│  │           - 법적 위계 준수                                               │    │
│  │           - 답변 구조: 핵심/근거/절차/사례/추가확인                        │    │
│  │           - 면책 문구 포함                                               │    │
│  └───────────────────────────────┬─────────────────────────────────────────┘    │
│                                  │                                              │
└──────────────────────────────────┼──────────────────────────────────────────────┘
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              응답 반환                                           │
│  {                                                                              │
│    "normalized_query": "표준화된 질문",                                          │
│    "references": ["주택임대차보호법 제3조", ...],                                 │
│    "answer": "AI 생성 답변",                                                      │
│    "docs": [...]                                                                │
│  }                                                                              │
└─────────────────────────────────────────────────────────────────────────────────┘
